name: CI (Linux)

on:
  pull_request:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build-test:
    name: Build & Test (Linux)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: "1"
      DOTNET_NOLOGO: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"
          cache: true
          cache-dependency-path: |
            **/packages.lock.json

      - name: Detect highest .NET SDK
        id: dotnet
        shell: bash
        run: |
          set -euo pipefail

          # List installed SDK versions (first column of `dotnet --list-sdks`)
          mapfile -t sdks < <(dotnet --list-sdks | awk '{print $1}')
          if [ ${#sdks[@]} -eq 0 ]; then
            echo "No .NET SDKs found" >&2
            exit 1
          fi

          # Split into stable vs prerelease
          stable=()
          prerelease=()
          for v in "${sdks[@]}"; do
            if [[ "$v" =~ (preview|rc|alpha|beta) ]]; then
              prerelease+=("$v")
            else
              stable+=("$v")
            fi
          done

          pick_highest() { printf "%s\n" "$@" | sort -V | tail -1; }

          if [ ${#stable[@]} -gt 0 ]; then
            chosen="$(pick_highest "${stable[@]}")"
            is_pre=false
          else
            chosen="$(pick_highest "${prerelease[@]}")"
            is_pre=true
          fi

          major="${chosen%%.*}"
          rest="${chosen#*.}"
          minor="${rest%%.*}"

          {
            echo "fullVersion=$chosen"
            echo "majorMinor=$major.$minor"
            echo "isPrerelease=$is_pre"
          } >> "$GITHUB_OUTPUT"

      - run: dotnet restore --locked-mode

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Test
        run: dotnet test --configuration Release --no-build --logger "trx;LogFileName=test-results.trx"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results-trx
          path: |
            **/TestResults/*.trx
            **/*.trx
          if-no-files-found: ignore
