name: Elo Evaluation

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  schedule:
    - cron: '0 3 * * *'
  pull_request:
    types: [labeled, unlabeled, opened, synchronize, reopened]
    branches: ["*"]

concurrency:
  group: elo-${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || format('{0}-{1}', github.workflow, github.ref) }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  actions: read
  statuses: write

jobs:
  elo:
    if: ${{ github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'elo') }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      ENGINE_PROJECT: Forklift.ConsoleClient/Forklift.ConsoleClient.csproj
      ENGINE_NAME: Forklift
      MATCH_DIR: matches
      CURRENT_ENGINE_DIR: artifacts/current/engine
      PREVIOUS_ENGINE_DIR: artifacts/previous/engine
      NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
          cache: true

      - name: Display .NET info
        run: dotnet --info

      - run: dotnet restore --locked-mode

      - name: Ensure PowerShell
        run: |
          set -euo pipefail
          if ! command -v pwsh >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y powershell
          fi
          pwsh --version

      - name: Install jq + curl
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Elo evaluation (PowerShell)
        shell: pwsh
        env:
          USE_APT_CUTECHESS: "1"
        run: |
          set -euo pipefail
          $output = taskset -c 0 pwsh -File ./scripts/elo-eval.ps1 `
            -VsParent `
            -Games 300 `
            -TimeControl '1+0.1' `
            -Concurrency 0
          $output | Tee-Object -FilePath 'matches/summary.txt'
          if ($env:GITHUB_STEP_SUMMARY) {
            $output | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          }

      - name: Gate on Elo regression
        if: ${{ always() }}
        shell: pwsh
        run: |
          $s = Get-Content matches/summary.json | ConvertFrom-Json
          if ($s.ordo -and $s.games -ge 200 -and $s.ordo.delta -lt -5) {
            Write-Error "Elo regression: Δ $($s.ordo.delta) over $($s.games) games"
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: elo-eval-${{ runner.os }}-${{ runner.arch }}-net${{ steps.dotnet.outputs.majorMinor || 'unknown' }}-${{ github.event.pull_request.number || github.run_id }}
          path: |
            matches/latest-vs-previous.pgn
            matches/ratings.txt
            matches/ratings.csv
            matches/logs
            matches/tool-versions.txt
            matches/summary.txt
            matches/summary.json
          retention-days: 30
          if-no-files-found: warn


      - name: Comment results on PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs')
            const sum = JSON.parse(fs.readFileSync('matches/summary.json','utf8'))
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            const artName = `elo-eval-${context.runId}`
            const body = [
              `**Elo Evaluation** for \`${context.sha.slice(0,7)}\``,
              `- Baseline: \`${sum.baseline || 'auto'}\``,
              `- Games: ${sum.games ?? '—'}`,
              `- SPRT: ${sum.sprt ?? '—'}`,
              sum.ordo ? `- Ordo Δ: **${sum.ordo.delta}** (±${sum.ordo.err})` : `- Ordo: (not run)`,
              ``,
              `Artifacts: [**${artName}**](${runUrl})`
            ].join('\n')
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            })

