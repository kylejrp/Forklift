name: Elo Evaluation

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  schedule:
    - cron: '0 3 * * *'
  pull_request:
    types: [labeled, unlabeled, opened, synchronize, reopened]
    branches: ["*"]

concurrency:
  group: elo-${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || format('{0}-{1}', github.workflow, github.ref) }}
  cancel-in-progress: true

jobs:
  elo:
    if: ${{ github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'elo') }}
    runs-on: ubuntu-latest
    env:
      ENGINE_PROJECT: Forklift.ConsoleClient/Forklift.ConsoleClient.csproj
      ENGINE_NAME: Forklift
      MATCH_DIR: matches
      CURRENT_ENGINE_DIR: artifacts/current/engine
      PREVIOUS_ENGINE_DIR: artifacts/previous/engine
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Ensure PowerShell
        run: |
          set -euo pipefail
          if ! command -v pwsh >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y powershell
          fi
          pwsh --version

      - name: Display .NET info
        run: dotnet --info

      - name: Install jq + curl + pwsh
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Elo evaluation (PowerShell)
        shell: pwsh
        env:
          USE_APT_CUTECHESS: "1"
        run: |
          $output = ./scripts/elo-eval.ps1 `
            -VsParent `
            -Games 300 `
            -TimeControl '1+0.1' `
            -Concurrency 0
          if (-not (Test-Path 'matches')) {
            New-Item -ItemType Directory -Path 'matches' | Out-Null
          }
          $output | Tee-Object -FilePath 'matches/summary.txt'
          if ($env:GITHUB_STEP_SUMMARY) {
            $output | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          }

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: elo-eval-${{ github.run_id }}
          path: |
            matches/latest-vs-previous.pgn
            matches/ratings.txt
            matches/ratings.csv
            matches/logs
            matches/tool-versions.txt
            matches/summary.txt
          if-no-files-found: warn
