name: Elo Evaluation

on:
  workflow_dispatch:
  push:
    branches: ["main"]
  schedule:
    - cron: '0 3 * * *'
  pull_request:
    types: [labeled, unlabeled, opened, synchronize, reopened]
    branches: ["*"]

concurrency:
  group: elo-${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || format('{0}-{1}', github.workflow, github.ref) }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  actions: read
  statuses: write

jobs:
  elo:
    if: ${{ github.event_name != 'pull_request' || contains(github.event.pull_request.labels.*.name, 'elo') }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      ENGINE_PROJECT: Forklift.ConsoleClient/Forklift.ConsoleClient.csproj
      ENGINE_NAME: Forklift
      MATCH_DIR: matches
      CURRENT_ENGINE_DIR: artifacts/current/engine
      PREVIOUS_ENGINE_DIR: artifacts/previous/engine
      NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
      DOTNET_CLI_TELEMETRY_OPTOUT: "1"
      DOTNET_NOLOGO: "1"
      COMPlus_ReadyToRun: "0"
      COMPlus_TieredCompilation: "0"
      COMPlus_TieredPGO: "0"
      DOTNET_GCServer: "1"
      COMPlus_GCHeapCount: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
          cache: true
          cache-dependency-path: |
            **/packages.lock.json

      - name: Display .NET info
        run: dotnet --info

      - run: dotnet restore --locked-mode

      - name: Detect .NET SDK full version
        id: dotnet
        shell: bash
        run: |
          set -euo pipefail
          version_string=$(dotnet --version | tr -d '\n' | xargs)
          major=$(echo "$version_string" | cut -d'.' -f1)
          minor=$(echo "$version_string" | cut -d'.' -f2)
          echo "majorMinor=$major.$minor" >> "$GITHUB_OUTPUT"

      - name: Ensure PowerShell
        run: |
          set -euo pipefail
          if ! command -v pwsh >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y powershell
          fi
          pwsh --version

      - name: Install jq + curl
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Elo evaluation (PowerShell)
        shell: pwsh
        env:
          USE_APT_CUTECHESS: "1"
        run: |
          $output = taskset -c 0 pwsh -File ./scripts/elo-eval.ps1 `
            -VsParent `
            -Games 300 `
            -TimeControl '1+0.1' `
            -Concurrency 0
          $output | Tee-Object -FilePath 'matches/summary.txt'
          if ($env:GITHUB_STEP_SUMMARY) {
            $output | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          }

      - name: Gate on Elo regression
        if: ${{ always() }}
        shell: pwsh
        run: |
          if (-not (Test-Path 'matches/summary.json')) {
            Write-Warning "matches/summary.json not found; skipping Elo gate."
            return
          }
          $s = Get-Content matches/summary.json | ConvertFrom-Json
          # Gate only if we have a delta and enough games
          if ($s.ordo -and $s.games -ge 200 -and $s.ordo.delta -lt -5) {
            Write-Error "Elo regression: Δ $($s.ordo.delta) over $($s.games) games"
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: elo-eval-${{ runner.os }}-${{ runner.arch }}-net${{ steps.dotnet.outputs.majorMinor }}-${{ github.event.pull_request.number || github.run_id }}
          path: |
            matches/latest-vs-previous.pgn
            matches/ratings.txt
            matches/ratings.csv
            matches/logs
            matches/tool-versions.txt
            matches/summary.txt
            matches/summary.json
          retention-days: 30
          if-no-files-found: warn


      - id: resolve_art
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        env:
          ART_NAME: elo-eval-${{ runner.os }}-${{ runner.arch }}-net${{ steps.dotnet.outputs.majorMinor }}-${{ github.event.pull_request.number || github.run_id }}
        with:
          script: |
            const {owner, repo} = context.repo;
            const run_id = context.runId;
            const list = await github.paginate(
              github.rest.actions.listWorkflowRunArtifacts,
              { owner, repo, run_id, per_page: 100 }
            );
            const a = list.find(x => x.name === process.env.ART_NAME && !x.expired);
            core.setOutput('ui_url', a ? `https://github.com/${owner}/${repo}/actions/runs/${run_id}/artifacts/${a.id}` : '');

      - name: Comment results on PR (rich)
        if: ${{ github.event_name == 'pull_request' && hashFiles('matches/summary.json') != '' }}
        uses: actions/github-script@v7
        env:
          ART_URL: ${{ steps.resolve_art.outputs.ui_url }}
        with:
          script: |
            const fs = require('fs')
            const sum = JSON.parse(fs.readFileSync('matches/summary.json','utf8'))
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            const art = process.env.ART_URL ? `[**Artifacts**](${process.env.ART_URL})` : `[**Run**](${runUrl})`
            const ord = sum.ordo
              ? `- Ordo Δ: **${sum.ordo.delta}** (±${sum.ordo.err ?? '—'})\n`
              : `- Ordo: (not run)\n`
            const body =
              `### ♟️ Elo Evaluation for \`${context.sha.slice(0,7)}\`\n` +
              `- Baseline: \`${sum.baseline || 'auto'}\`\n` +
              `- Games: ${sum.games ?? '—'}\n` +
              `- SPRT: ${sum.sprt ?? '—'}\n` +
              ord +
              `\n${art}\n` +
              (sum.cutechess
                ? `\n<details><summary>cutechess-cli</summary>\n\n\`${sum.cutechess}\`\n</details>\n`
                : '')
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            })

      - name: Summarize Elo results (main/schedule)
        if: ${{ always() && github.event_name != 'pull_request' }}
        shell: bash
        run: |
          {
            echo "### ♟️ Elo Evaluation"
            if [ -f matches/summary.json ]; then
              jq -r '
                def num(n): if n==null then "—" else (n|tostring) end;
                "* Baseline:* \(.baseline // "auto")  \n" +
                "* Games:* \(num(.games))  \n" +
                "* SPRT:* \(.sprt // "—")  \n" +
                (if .ordo then
                  "* Ordo Δ:* **\(.ordo.delta)** (±\(.ordo.err // "—"))  \n"
                else "* Ordo:* (not run)  \n" end)
              ' matches/summary.json
            else
              echo "_No summary.json produced._"
            fi
            echo
            echo "<details><summary>cutechess-cli command</summary>"
            if [ -f matches/summary.json ]; then
              jq -r '.cct_cmd // .cutechess // ""' matches/summary.json
            fi
            echo "</details>"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Set commit status (failure) on main regression
        if: ${{ always() && github.event_name != 'pull_request' && hashFiles('matches/summary.json') != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const sum = JSON.parse(fs.readFileSync('matches/summary.json','utf8'));
            const isReg =
              !!sum.ordo &&
              typeof sum.ordo.delta === 'number' &&
              typeof sum.games === 'number' &&
              sum.games >= 200 &&
              sum.ordo.delta < -5;
            const {owner, repo} = context.repo;
            await github.rest.repos.createCommitStatus({
              owner, repo,
              sha: context.sha,
              state: isReg ? "failure" : "success",
              context: "Forklift Elo",
              description: isReg ? "Elo regression detected on main" : "Elo check passed",
              target_url: `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`
            });
